FROM public.ecr.aws/docker/library/node:20 AS builder

# Set working dir first so all paths are relative to /app
WORKDIR /app

# Copy dependencies and linked packages first for better caching
COPY keeper-bots-v2/package.json keeper-bots-v2/yarn.lock ./
COPY protocol-v2/sdk ./protocol-v2/sdk
COPY keeper-bots-v2/drift-common ./drift-common

# Build dependencies
WORKDIR /app/drift-common/protocol/sdk
RUN yarn install && yarn run build

WORKDIR /app/drift-common/common-ts
RUN yarn install && yarn run build

# Copy the rest of keeper-bots-v2 AFTER deps are installed
WORKDIR /app
COPY keeper-bots-v2 .
RUN yarn install

# Run your build script
RUN node esbuild.config.js

# Final minimal image
FROM public.ecr.aws/docker/library/node:20.18.1-alpine

# Optional native deps for performance
RUN apk add python3 make g++ --virtual .build &&\
    npm install -C /lib bigint-buffer @triton-one/yellowstone-grpc@1.3.0 helius-laserstream &&\
    apk del .build &&\
    rm -rf /root/.cache/ /root/.npm /usr/local/lib/node_modules 

COPY --from=builder /app/lib/ ./lib/

EXPOSE 9464

CMD ["node", "./lib/index.js"]
