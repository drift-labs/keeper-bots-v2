name: PR Bot Dry-Run Test

on:
  pull_request:
    branches: [master]

jobs:
  bot-dry-run:
    runs-on: ubicloud
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'

      - name: Setup node
        uses: actions/setup-node@v2
        with:
          node-version: "22.14.x"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: |
          cd drift-common/protocol/sdk
          yarn install
          yarn build
          cd ../../common-ts
          yarn install
          yarn build
          cd ../../
          yarn install

      - name: Build
        run: yarn run build

      - name: Run bot dry-run test (trigger + userPnlSettler)
        env:
          KEEPER_PRIVATE_KEY: ${{ secrets.KEEPER_PRIVATE_KEY }}
        run: |
          # Run 2 bots (trigger + userPnlSettler) in dry-run mode
          # Tests that bots can initialize and run one loop without errors
          timeout 180 node lib/index.js --config-file .github/ci-test-config.yaml || exit_code=$?
          
          # timeout (exit 124) is acceptable - means bots ran successfully
          if [ "${exit_code:-0}" -eq 124 ]; then
            echo "Bot test timed out after 180s - this is acceptable (bots initialized and ran)"
            exit 0
          elif [ "${exit_code:-0}" -ne 0 ]; then
            echo "Bot dry-run test failed with exit code ${exit_code}"
            exit 1
          fi
          echo "Bot dry-run test completed successfully"
